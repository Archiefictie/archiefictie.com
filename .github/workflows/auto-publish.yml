name: Auto Publish Random Story

on:
  workflow_dispatch:       # handmatige trigger
  schedule:
    - cron: '0 10 * * 2'  # elke dinsdag om 11:00 CET

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Git
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      # 3️⃣ Kies random verhaal uit pool
      - name: Pick random story
        id: pick
        run: |
          FILE=$(ls pool/*.html | shuf -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

      # 4️⃣ Kopieer naar live-stories
      - name: Copy to live-stories
        run: |
          cp "${{ steps.pick.outputs.file }}" live-stories/

      # 5️⃣ Verwijder bestand uit pool
      - name: Remove from pool
        run: |
          git rm "${{ steps.pick.outputs.file }}"

      # 6️⃣ Update index.html (rebuild + filter duplicaten)
      - name: Rebuild index.html
        run: |
          TMP_FILE=$(mktemp)

          # Maak tijdelijke lijst van unieke links
          declare -A seen
          echo "" > "$TMP_FILE"

          for f in live-stories/*.html; do
            NAME=$(basename "$f" .html)
            if [ -z "${seen[$NAME]}" ]; then
              echo "  <li><a href=\"$f\">$NAME</a></li>" >> "$TMP_FILE"
              seen[$NAME]=1
            fi
          done

          # Plaats tussen workflow start/end in index.html
          awk -v linksfile="$TMP_FILE" '
            /<!-- workflow start -->/ {print; system("cat " linksfile); next}
            /<!-- workflow end -->/ {print; next}
            !/<!-- workflow start -->/ && !/<!-- workflow end -->/ {print}
          ' index.html > index_new.html

          mv index_new.html index.html
          rm "$TMP_FILE"

      # 7️⃣ Commit & Push
      - name: Commit & Push
        run: |
          git add live-stories/ index.html
          git commit -m "Auto publish random story: $(basename ${{ steps.pick.outputs.file }})"
          git push origin main
