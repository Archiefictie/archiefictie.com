name: Auto Publish Random Story

on:
  workflow_dispatch:       # handmatige trigger
  schedule:
    - cron: '0 10 * * 2'  # elke dinsdag om 11:00 CET

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Git
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      # 3️⃣ Kies random verhaal uit pool
      - name: Pick random story
        id: pick
        run: |
          FILE=$(ls pool/*.html | shuf -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

      # 4️⃣ Kopieer naar live-stories
      - name: Copy to live-stories
        run: |
          cp "${{ steps.pick.outputs.file }}" live-stories/

      # 5️⃣ Verwijder bestand uit pool
      - name: Remove from pool
        run: |
          git rm "${{ steps.pick.outputs.file }}"

      # 6️⃣ Update index.html
      - name: Update index.html
        run: |
          # Maak tijdelijke links
          LINKS=""
          for f in live-stories/*.html; do
            NAME=$(basename "$f" .html)
            LINKS="$LINKS  <li><a href=\"$f\">$NAME</a></li>\n"
          done

          # Vervang content tussen <!-- workflow start --> en <!-- workflow end -->
          sed -i '/<!-- workflow start -->/,/<!-- workflow end -->/c\
<!-- workflow start -->\n'"$LINKS"'<!-- workflow end -->' index.html

      # 7️⃣ Commit & push
      - name: Commit & Push
        run: |
          git add live-stories/ index.html
          git commit -m "Auto publish random story: $(basename ${{ steps.pick.outputs.file }})"
          git push origin main
